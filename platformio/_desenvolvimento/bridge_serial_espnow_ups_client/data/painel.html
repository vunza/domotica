<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor - Sensores</title>
    <link rel="icon" href="data:,"> <!-- Favicon vazio -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            padding: 20px;
            max-width: 900px;
            width: 100%;
        }

        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { color:#2c3e50; font-size:2em; margin-bottom:5px; }
        .header p { color:#7f8c8d; font-size:0.9em; }

        .gauges-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .gauges-container { grid-template-columns: repeat(4,1fr); }
        }

        .gauge-card {
            background:white;
            border-radius:12px;
            padding:15px;
            box-shadow:0 5px 15px rgba(0,0,0,0.1);
            text-align:center;
            border-top:4px solid #3498db;
        }

        .gauge-card.voltage { border-top-color:#e74c3c; }
        .gauge-card.current { border-top-color:#2ecc71; }
        .gauge-card.temperature { border-top-color:#f39c12; }
        .gauge-card.humidity { border-top-color:#3498db; }

        .gauge-title { font-size:1em; color:#2c3e50; margin-bottom:15px; font-weight:600; }

        .gauge-wrapper {
            position:relative;
            width:120px;
            height:120px;
            margin:0 auto 10px;
        }

        canvas { width:100%; height:100%; }

        .gauge-value {
            position:absolute;
            top:50%; left:50%;
            transform:translate(-50%,-50%);
            font-size:1.8em;
            font-weight:bold;
            color:#2c3e50;
        }

        .gauge-unit { font-size:0.5em; color:#7f8c8d; margin-left:2px; }

        .gauge-minmax { display:flex; justify-content:space-between; margin-top:8px; color:#7f8c8d; font-size:0.7em; }

        .status-indicator {
            display:inline-block;
            width:8px; height:8px;
            border-radius:50%;
            margin-right:5px;
        }

        .status-normal { background:#2ecc71; }
        .status-warning { background:#f39c12; }
        .status-danger  { background:#e74c3c; }

        .info-panel {
            background:linear-gradient(135deg,#34495e,#2c3e50);
            color:white;
            border-radius:12px;
            padding:15px;
            margin-top:15px;
        }

        .info-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:15px; }
        .info-item { text-align:center; }
        .info-label { font-size:0.8em; color:#bdc3c7; }
        .info-value { font-size:1.1em; font-weight:bold; color:#ecf0f1; }

        .last-update { text-align:center; margin-top:15px; color:#7f8c8d; font-size:0.8em; }

        .controls { display:flex; justify-content:center; gap:10px; margin-top:15px; }
        .btn {
            padding:8px 16px;
            border-radius:6px;
            background:linear-gradient(135deg,#3498db,#2980b9);
            color:white;
            border:none;
            cursor:pointer;
        }
        .btn-refresh { background:linear-gradient(135deg,#2ecc71,#27ae60); }
        .btn-settings { background:linear-gradient(135deg,#f39c12,#e67e22); }
    </style>
</head>

<body>
<div class="container">
    <div class="header">
        <h1>üìä Monitor de Sensores</h1>
        <p>Monitoramento em tempo real</p>
    </div>

    <div class="gauges-container">

        <!-- TEMPLATE DE GAUGE (REPETE PARA TENS√ÉO, CORRENTE, ETC) -->
        <!-- TENS√ÉO -->
        <div class="gauge-card voltage">
            <div class="gauge-title"><span class="status-indicator status-normal"></span>Tens√£o</div>
            <div class="gauge-wrapper">
                <canvas id="voltageGauge" width="120" height="120"></canvas>
                <canvas id="voltagePointer" width="120" height="120" style="position:absolute;top:0;left:0;"></canvas>

                <div class="gauge-value">
                    <span id="voltageValue">0.00</span><span class="gauge-unit">V</span>
                </div>
            </div>
            <div class="gauge-minmax"><span>0V</span><span>14V</span></div>
        </div>

        <!-- CORRENTE -->
        <div class="gauge-card current">
            <div class="gauge-title"><span class="status-indicator status-normal"></span>Corrente</div>
            <div class="gauge-wrapper">
                <canvas id="currentGauge" width="120" height="120"></canvas>
                <canvas id="currentPointer" width="120" height="120" style="position:absolute;top:0;left:0;"></canvas>

                <div class="gauge-value">
                    <span id="currentValue">0.00</span><span class="gauge-unit">A</span>
                </div>
            </div>
            <div class="gauge-minmax"><span>0A</span><span>3A</span></div>
        </div>

        <!-- TEMPERATURA -->
        <div class="gauge-card temperature">
            <div class="gauge-title"><span class="status-indicator status-normal"></span>Temperatura</div>
            <div class="gauge-wrapper">
                <canvas id="temperatureGauge" width="120" height="120"></canvas>
                <canvas id="temperaturePointer" width="120" height="120" style="position:absolute;top:0;left:0;"></canvas>

                <div class="gauge-value">
                    <span id="temperatureValue">0.00</span><span class="gauge-unit">¬∞C</span>
                </div>
            </div>
            <div class="gauge-minmax"><span>-10¬∞C</span><span>50¬∞C</span></div>
        </div>

        <!-- UMIDADE -->
        <div class="gauge-card humidity">
            <div class="gauge-title"><span class="status-indicator status-normal"></span>Umidade</div>
            <div class="gauge-wrapper">
                <canvas id="humidityGauge" width="120" height="120"></canvas>
                <canvas id="humidityPointer" width="120" height="120" style="position:absolute;top:0;left:0;"></canvas>

                <div class="gauge-value">
                    <span id="humidityValue">0.00</span><span class="gauge-unit">%</span>
                </div>
            </div>
            <div class="gauge-minmax"><span>0%</span><span>100%</span></div>
        </div>

    </div>

    <div class="info-panel">
        <div class="info-grid">
            <div class="info-item"><div class="info-label">Pot√™ncia</div><div id="powerValue" class="info-value">0.00 W</div></div>
            <div class="info-item"><div class="info-label">Energia Consumida</div><div id="energyValue" class="info-value">0.00 Wh</div></div>
            <div class="info-item"><div class="info-label">Tempo de Opera√ß√£o</div><div id="uptimeValue" class="info-value">00:00:00</div></div>
            <div class="info-item"><div class="info-label">Estado do Sistema</div><div id="systemStatus" class="info-value">Normal</div></div>
        </div>
    </div>

    <div class="last-update">√öltima atualiza√ß√£o: <span id="lastUpdate">--:--:--</span></div>

    <div class="controls">
        <button class="btn btn-refresh" onclick="refreshData()">üîÑ Atualizar</button>
        <button class="btn btn-settings" onclick="showSettings()">‚öôÔ∏è Configura√ß√µes</button>
    </div>
</div>


<script>
    /* ----------------------------
    CONFIGURA√á√ÉO DOS GAUGES
    ----------------------------- */

    /**
     * Rota da API que fornece os valores dos sensores.
     * @constant {string}
     */
    const rota = "/api/sensores";

    /**
     * Estrutura de configura√ß√£o dos gauges.
     * Cada gauge possui:
     * - canvas base (arco fixo)
     * - canvas do ponteiro
     * - elemento HTML para exibir o valor num√©rico
     * - limites e n√≠veis de alerta
     * - segmentos de cor
     *
     * @typedef {Object} GaugeSegment
     * @property {number} from Valor inicial do segmento
     * @property {number} to Valor final do segmento
     * @property {string} color Cor do segmento
     *
     * @typedef {Object} GaugeConfigItem
     * @property {HTMLCanvasElement} canvas Canvas onde o arco √© desenhado
     * @property {HTMLCanvasElement} pointerCanvas Canvas exclusivo do ponteiro
     * @property {HTMLElement} valueElement Elemento HTML onde o valor √© exibido
     * @property {number} min Valor m√≠nimo aceito
     * @property {number} max Valor m√°ximo aceito
     * @property {number} warning Faixa de aviso
     * @property {number} danger Faixa de perigo
     * @property {GaugeSegment[]} segments Segmentos coloridos do gauge
     */

    /**
     * Conjunto com a configura√ß√£o de todos os gauges.
     * @type {Object.<string, GaugeConfigItem>}
     */
    const gaugeConfig = {
        voltage: {
            canvas: document.getElementById('voltageGauge'),
            pointerCanvas: document.getElementById('voltagePointer'),
            valueElement: document.getElementById('voltageValue'),
            min: 0, max: 14, warning: 12, danger: 13,
            segments: [
                { from: 0, to: 10, color: '#e74c3c' },
                { from: 10, to: 12, color: '#f39c12' },
                { from: 12, to: 14, color: '#2ecc71' }
            ]
        },

        current: {
            canvas: document.getElementById('currentGauge'),
            pointerCanvas: document.getElementById('currentPointer'),
            valueElement: document.getElementById('currentValue'),
            min: 0, max: 3000, warning: 2400, danger: 2700,
            segments: [
                { from: 0, to: 2000, color: '#2ecc71' },
                { from: 2000, to: 2400, color: '#f39c12' },
                { from: 2400, to: 3000, color: '#e74c3c' }
            ]
        },

        temperature: {
            canvas: document.getElementById('temperatureGauge'),
            pointerCanvas: document.getElementById('temperaturePointer'),
            valueElement: document.getElementById('temperatureValue'),
            min: -10, max: 50, warning: 40, danger: 45,
            segments: [
                { from: -10, to: 0, color: '#3498db' },
                { from: 0, to: 30, color: '#2ecc71' },
                { from: 30, to: 40, color: '#f39c12' },
                { from: 40, to: 50, color: '#e74c3c' }
            ]
        },

        humidity: {
            canvas: document.getElementById('humidityGauge'),
            pointerCanvas: document.getElementById('humidityPointer'),
            valueElement: document.getElementById('humidityValue'),
            min: 0, max: 100, warning: 80, danger: 90,
            segments: [
                { from: 0, to: 30, color: '#e74c3c' },
                { from: 30, to: 60, color: '#2ecc71' },
                { from: 60, to: 80, color: '#f39c12' },
                { from: 80, to: 100, color: '#3498db' }
            ]
        }
    };

    /* ----------------------------
    DESENHO DO GAUGE FIXO
    ----------------------------- */

    /**
     * Desenha o arco fixo do gauge (sem ponteiro).
     * Este desenho √© est√°tico e s√≥ precisa ser feito uma vez.
     *
     * @param {GaugeConfigItem} config Configura√ß√µes do gauge
     */
    function drawGauge(config) {
        const ctx = config.canvas.getContext('2d');
        const w = config.canvas.width;
        const h = config.canvas.height;
        const cx = w / 2, cy = h / 2;
        const radius = Math.min(cx, cy) - 8;

        ctx.clearRect(0, 0, w, h);

        const start = Math.PI;
        const full = Math.PI;

        config.segments.forEach(seg => {
            ctx.beginPath();
            const a1 = start + (seg.from / config.max) * full;
            const a2 = start + (seg.to / config.max) * full;
            ctx.arc(cx, cy, radius, a1, a2);
            ctx.strokeStyle = seg.color;
            ctx.lineWidth = 10;
            ctx.stroke();
        });

        ctx.strokeStyle = "#34495e";
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.arc(cx, cy, radius + 6, start, start + full); ctx.stroke();
        ctx.beginPath(); ctx.arc(cx, cy, radius - 6, start, start + full); ctx.stroke();
    }

    /* ----------------------------
    DESENHO DO PONTEIRO
    ----------------------------- */

    /**
     * Renderiza o ponteiro do gauge.
     * Apenas o canvas do ponteiro √© limpo, evitando apagar o gauge fixo.
     *
     * @param {GaugeConfigItem} config Configura√ß√µes do gauge
     * @param {number} value Valor a ser exibido pelo ponteiro
     */
    function drawPointer(config, value) {
        const ctx = config.pointerCanvas.getContext('2d');
        const w = config.pointerCanvas.width;
        const h = config.pointerCanvas.height;

        ctx.clearRect(0, 0, w, h);

        const cx = w / 2, cy = h / 2;
        const radius = Math.min(cx, cy) - 8;

        const val = Math.max(config.min, Math.min(config.max, value));
        const angle = Math.PI + (val / config.max) * Math.PI;

        ctx.strokeStyle = "#2c3e50";
        ctx.lineWidth = 2;

        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(cx + Math.cos(angle) * (radius - 12), cy + Math.sin(angle) * (radius - 12));
        ctx.stroke();

        ctx.fillStyle = "#2c3e50";
        ctx.beginPath();
        ctx.arc(cx, cy, 6, 0, Math.PI * 2);
        ctx.fill();
    }

    /* ----------------------------
        ATUALIZA√á√ÉO DOS GAUGES
    ----------------------------- */

    /**
     * Atualiza todos os gauges com novos valores.
     *
     * @param {number} v Tens√£o (V)
     * @param {number} c Corrente (mA)
     * @param {number} t Temperatura (¬∞C)
     * @param {number} h Umidade (%)
     */
    function updateGauges(v, c, t, h) {
        gaugeConfig.voltage.valueElement.textContent = v.toFixed(2);
        drawPointer(gaugeConfig.voltage, v);

        gaugeConfig.current.valueElement.textContent = c.toFixed(2);
        drawPointer(gaugeConfig.current, c);

        gaugeConfig.temperature.valueElement.textContent = t.toFixed(1);
        drawPointer(gaugeConfig.temperature, t);

        gaugeConfig.humidity.valueElement.textContent = h.toFixed(1);
        drawPointer(gaugeConfig.humidity, h);

        updateDerivedInfo(v, c);
        updateTimestamp();
    }

    /* ----------------------------
    INFORMA√á√ïES DERIVADAS
    ----------------------------- */

    /**
     * Calcula pot√™ncia (W) e atualiza o painel de informa√ß√µes.
     *
     * @param {number} v Tens√£o em volts
     * @param {number} c Corrente em mA
     */
    function updateDerivedInfo(v, c) {
        const watts = v * (c / 1000);
        document.getElementById('powerValue').textContent = watts.toFixed(2) + " W";
    }

    /* ----------------------------
    TIMESTAMP
    ----------------------------- */

    /**
     * Atualiza o timestamp da √∫ltima leitura exibida.
     */
    function updateTimestamp() {
        document.getElementById('lastUpdate').textContent =
            new Date().toLocaleTimeString('pt-BR');
    }

    /* ----------------------------
    BUSCA API
    ----------------------------- */

    /**
     * Consulta a API `/api/sensores` e atualiza os gauges.
     * Caso a API falhe, aplica valores 0 como fallback.
     */
    function refreshData() {
        fetch(rota)
            .then(r => r.json())
            .then(data => {
                updateGauges(data.voltage, data.current, data.temperature, data.humidity);
            })
            .catch(() => {
                updateGauges(0, 0, 0, 0);
            });
    }

    /* ----------------------------
    INICIALIZA√á√ÉO
    ----------------------------- */

    /**
     * Inicializa o sistema quando a p√°gina √© carregada:
     * - desenha todos os gauges fixos
     * - faz a primeira leitura
     * - define atualiza√ß√£o autom√°tica a cada 2s
     *
     * @global
     */
    window.onload = function () {
        Object.values(gaugeConfig).forEach(drawGauge);
        refreshData();
        setInterval(refreshData, 2000);
    };

    /**
     * Entra em modo de configura√ß√µes (programa√ß√£o via OTA).
     */
    function showSettings() {
        window.location.href = "/ota";
    }

</script>

</body>
</html>
